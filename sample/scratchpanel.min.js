function ScratchPanel(e){function t(){m=document.getElementById(e.elementId),p=document.createElement("canvas"),v=p.getContext("2d"),e.width=m.clientWidth,e.height=m.clientHeight,p.width=e.width,p.height=e.height,m.appendChild(p)}function n(){if(!e.foreground)return console.error("A foreground image must be specified");var t=document.createElement("img");""!=e.crossOrigin&&(t.crossOrigin=e.crossOrigin),t.src=e.foreground,t.onload=function(){v.drawImage(t,0,0,e.width,e.height),e.background?setTimeout(function(){m.style.backgroundImage="url('"+e.background+"')",a()},e.backgroundLoadDelay):a()}}function a(){w=!0,e.readyCallback&&e.readyCallback.apply(null)}function i(){p.addEventListener("mousedown",l),p.addEventListener("mousemove",u),p.addEventListener("mouseup",d),p.addEventListener("touchstart",l),p.addEventListener("touchmove",u),p.addEventListener("touchend",d)}function o(){b=r(function(){h(),e.callback&&e.callback.apply(null)})}function r(e){return function(){if(f=e,e=null,null!=f)return f.apply(this,arguments)}}function c(){return e.enabled&&w}function l(t){if(c()){t.preventDefault(),y=!0;var n=s(t);v.globalCompositeOperation="destination-out",v.lineJoin="round",v.lineCap="round",v.strokeStyle="#000000",v.fillStyle="#000000",v.lineWidth=e.scratchSize,v.beginPath(),v.arc(n.x,n.y,e.scratchSize/2,0,2*Math.PI,!0),v.closePath(),v.fill(),v.beginPath(),v.moveTo(n.x,n.y)}}function u(t){if(c()&&(t.preventDefault(),y)){var n=s(t);v.lineTo(n.x,n.y),v.stroke(),k%5==0&&g()>=e.threshold&&b(),k++}}function d(e){c()&&(e.preventDefault(),y=!1,v.closePath())}function h(){v.clearRect(0,0,e.width,e.height)}function s(e){var t=e.target.getBoundingClientRect();return e.clientX?{x:e.clientX-t.left,y:e.clientY-t.top}:e.touches[0]?{x:e.touches[0].clientX-t.left,y:e.touches[0].clientY-t.top}:void 0}function g(){for(var t=v.getImageData(0,0,e.width,e.height),n=0,a=0,i=0;i<t.data.length;i+=4)0===t.data[i]&&0===t.data[i+1]&&0===t.data[i+2]&&0===t.data[i+3]&&(a+=1),n+=1;return a/n*100}var m,p,v,b,y,k=0,w=!1;e=e||{};var E={elementId:"scratch-panel",threshold:65,callback:null,readyCallback:null,foreground:"",background:"",crossOrigin:"",scratchSize:40,enabled:!0,backgroundLoadDelay:300};return function(){for(var a in E)e.hasOwnProperty(a)||(e[a]=E[a]);t(),n(),i(),o()}(),{getPercentScratched:g,clear:h,setOption:function(t,n){e[t]=n},getOption:function(t){return e[t]}}}