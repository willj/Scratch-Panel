function ScratchPanel(e){function t(){b=document.getElementById(e.elementId),y=document.createElement("canvas"),k=y.getContext("2d"),n(),b.appendChild(y)}function n(){e.width=b.clientWidth,e.height=b.clientHeight,y.width=e.width,y.height=e.height}function i(){if(!e.foreground)return console.error("A foreground image must be specified");w=document.createElement("img"),""!=e.crossOrigin&&(w.crossOrigin=e.crossOrigin),w.src=e.foreground,w.onload=function(){o(),e.background?setTimeout(function(){b.style.backgroundImage="url('"+e.background+"')",a()},e.backgroundLoadDelay):a()}}function o(){k.drawImage(w,0,0,e.width,e.height)}function a(){O=!0,e.readyCallback&&e.readyCallback.apply(null)}function r(){window.addEventListener("resize",p),y.addEventListener("mousedown",d),y.addEventListener("mousemove",s),y.addEventListener("mouseup",h),y.addEventListener("touchstart",d),y.addEventListener("touchmove",s),y.addEventListener("touchend",h)}function c(){E=l(function(){g(),window.removeEventListener("resize",p),b.removeChild(y),e.callback&&e.callback.apply(null)})}function l(e){return function(){if(f=e,e=null,null!=f)return f.apply(this,arguments)}}function u(){return e.enabled&&O}function d(t){if(u()){t.preventDefault(),L=!0;var n=v(t);k.globalCompositeOperation="destination-out",k.lineJoin="round",k.lineCap="round",k.strokeStyle="#000000",k.fillStyle="#000000",k.lineWidth=e.scratchSize,k.beginPath(),k.arc(n.x,n.y,e.scratchSize/2,0,2*Math.PI,!0),k.closePath(),k.fill(),k.beginPath(),k.moveTo(n.x,n.y)}}function s(t){if(u()&&(t.preventDefault(),L)){var n=v(t);k.lineTo(n.x,n.y),k.stroke(),C%5==0&&m()>=e.threshold&&E(),C++}}function h(e){u()&&(e.preventDefault(),L=!1,k.closePath())}function g(){k.clearRect(0,0,e.width,e.height)}function v(e){var t=e.target.getBoundingClientRect();return e.clientX?{x:e.clientX-t.left,y:e.clientY-t.top}:e.touches[0]?{x:e.touches[0].clientX-t.left,y:e.touches[0].clientY-t.top}:void 0}function m(){for(var t=k.getImageData(0,0,e.width,e.height),n=0,i=0,o=0;o<t.data.length;o+=4)0===t.data[o]&&0===t.data[o+1]&&0===t.data[o+2]&&0===t.data[o+3]&&(i+=1),n+=1;return i/n*100}function p(t){e.autoResize&&(n(),o())}var b,y,k,w,E,L,C=0,O=!1;e=e||{};var P={elementId:"scratch-panel",threshold:65,callback:null,readyCallback:null,foreground:"",background:"",crossOrigin:"",scratchSize:40,enabled:!0,backgroundLoadDelay:300,autoResize:!0};return function(){for(var n in P)e.hasOwnProperty(n)||(e[n]=P[n]);t(),i(),r(),c()}(),{getPercentScratched:m,clear:g,setOption:function(t,n){e[t]=n},getOption:function(t){return e[t]}}}